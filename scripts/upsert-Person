// set the search table name
 // find the table
const searchTable = "People"
let table = base.getTable(searchTable);
// console.log({table})

// initiate the config
let inputConfig = input.config();
let firstName = inputConfig.firstName[0];
let middleName = inputConfig.middleName[0];
let lastName = inputConfig.lastName[0];
let primaryEmail = inputConfig.primaryEmail[0];

// inititate other variables
let Record_ID = "";
let Action_Status = "Null";

// ***** Create 'searchable_id *****
// Last-First-(middle first initial)-email, all lowercase
const createSearchableId = (data) => {
  console.log({data})
  let {firstName, middleName, lastName, primaryEmail} = data;
  let nameArr = [];

  nameArr.push(...lastName.split(" "));
  nameArr.push(...firstName.split(" "));
  // Clean up middleName
  data.middleName && nameArr.push(middleName[0]);
  nameArr.push(primaryEmail);

  return nameArr.join("-").toLowerCase();
};
// **************************

// get the records
let fields = ['first name', "last name", "primary email", "searchable_id"]
let people = await table.selectRecordsAsync({fields})

// create searchable string
let data = {firstName, middleName, lastName, primaryEmail};
let searchable_id = createSearchableId(data);

let foundRecords = people.records.find(
  person => person.getCellValueAsString("searchable_id") === searchable_id
)

let hasData = firstName !== "" && lastName !== "" && primaryEmail !== "";

// No Data
if (!hasData) {
  console.error("missing Person Information");
  Action_Status = "No Data";
}

// Updated || Found
if (hasData && foundRecords) {
    Record_ID = foundRecords.id;
    Action_Status = "Found";

    console.log('Found Record', {foundRecords})
}

// Created
if(hasData && !foundRecords) {
  let newRecordId="";

  try {
    newRecordId = await table.createRecordAsync({
      "first name": firstName,
      "last name": lastName,
      "primary email": primaryEmail
    });
  
  Record_ID = newRecordId;
  Action_Status = "Created";
  console.log('New Record Created', {newRecordId})

  } catch(error) {
    console.error(error);
  }
}

// Set outputs
output.set("searchable_id", searchable_id);
output.set("Record_ID", Record_ID);
output.set("Action_Status", Action_Status);